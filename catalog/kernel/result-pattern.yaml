id: result-pattern
version: 1.1.0
name: Result Pattern (Railway Oriented Programming)
category: kernel
intent: 例外に頼らないエラーハンドリングの基盤。VSA.Applicationで提供。

description: |
  Result<T>パターンは、処理の成功/失敗を明示的に表現するパターンです。
  VSA.Application NuGetパッケージで提供されます。

  【なぜ例外ではなくResultを使うのか】
  - 例外は「予期しないエラー」のためのもの
  - ビジネスロジック上のエラー（例: 在庫不足、権限なし）は「予期されるエラー」
  - 予期されるエラーは戻り値で明示的に伝播する方が意図が明確

nuget_package: VSA.Application

applicability:
  always_apply: true
  reason: "すべてのCommand/Queryの戻り値として使用される基盤パターン"

implementation:
  file_path: "VSA.Application内で提供（自分で実装不要）"
  namespace: "VSA.Application"
  template: |
    // VSA.Application で提供される Result 型
    //
    // Result: 成功/失敗を表す
    // Result<T>: 値を持つ成功/失敗を表す
    //
    // 使用方法:
    // using VSA.Application;
    // return Result.Success(value);
    // return Result.Fail<T>("エラーメッセージ");

example_usage: |
  using VSA.Application;
  using VSA.Application.Interfaces;

  // Command の戻り値は Result<T>
  public sealed record CreateProductCommand(
      string Name,
      decimal Price
  ) : ICommand<Result<ProductId>>;

  // Handler の実装
  public async Task<Result<ProductId>> Handle(
      CreateProductCommand request,
      CancellationToken ct)
  {
      // 検証失敗時は Result.Fail を返す（例外をthrowしない）
      if (string.IsNullOrEmpty(request.Name))
          return Result.Fail<ProductId>("商品名は必須です");

      var product = Product.Create(ProductId.New(), request.Name);
      await _repository.AddAsync(product, ct);

      return Result.Success(product.Id);
  }

  // 呼び出し側での使用
  var result = await _mediator.Send(new CreateProductCommand("商品A", 1000));

  // パターン1: IsSuccess で判定
  if (!result.IsSuccess)
  {
      _logger.LogWarning("商品作成失敗: {Error}", result.Error);
      return BadRequest(result.Error);
  }
  return Ok(result.Value);

  // パターン2: Match で分岐
  var response = result.Match(
      onSuccess: id => new { Success = true, ProductId = id.Value },
      onFailure: error => new { Success = false, Error = error }
  );

ai_guidance:
  when_to_use:
    - "すべてのCommand/Queryの戻り値型として使用"
    - "ビジネスロジック上のエラーを伝播する場合"
    - "検証失敗、存在しない、権限なしなどの「予期されるエラー」"

  when_not_to_use:
    - "インフラ層の予期しないエラー（DB接続エラー等）→ 例外を使用"
    - "プログラミングエラー（null参照等）→ 例外を使用"

  common_mistakes:
    - mistake: "例外をthrowしてビジネスエラーを伝播する"
      severity: critical
      solution: "Result.Fail<T>(error) を返す"

    - mistake: "Result.IsSuccess を確認せずに Value にアクセス"
      severity: high
      solution: "必ず IsSuccess を確認するか、Match メソッドを使用"

    - mistake: "VSA.Applicationを使わずに独自のResult型を作る"
      severity: high
      solution: "VSA.Application.Resultを使用"

dependencies:
  nuget:
    - name: "VSA.Application"
      version: "1.3.0"
      required: true

related_patterns:
  - id: validation-behavior
    description: "FluentValidation の検証結果は自動的に Result.Fail に変換される"

  - id: boundary-pattern
    description: "BoundaryDecision と Result は相互変換可能"

changelog:
  - version: 1.1.0
    date: 2025-12-28
    changes:
      - "VSA.Framework統合"
      - "NuGetパッケージ参照に変更"

  - version: 1.0.0
    date: 2025-11-27
    changes:
      - "初版リリース"

evidence:
  implementation_file: "VSA.Application/Result.cs"
  skill_file: ".claude/skills/vsa-application.md"
